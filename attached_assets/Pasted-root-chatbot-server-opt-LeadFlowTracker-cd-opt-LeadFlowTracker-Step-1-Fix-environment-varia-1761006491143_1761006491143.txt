root@chatbot-server:/opt/LeadFlowTracker# cd /opt/LeadFlowTracker

# Step 1: Fix environment variables
cat > .env << 'EOF'
DATABASE_URL=postgresql://doadmin:AVBL_u0StE4lNxN7w7hsU8L_NLE6@db-memory-do-user-17481003-0.c.db.ondigitalocean.com:25061/ai-memory-pool?sslmode=require
DO_DATABASE_URL=postgresql://doadmin:AVBL_u0StE4lNxN7w7hsU8L_NLE6@db-memory-do-user-17481003-0.c.db.ondigitalocean.com:25061/ai-memory-pool?sslmode=require
SESSION_SECRET=$(openssl rand -base64 32)
NODE_ENV=production
PORT=5001
EOF

# Step 2: Push database schema
npm run db:push --force

# Step 3: Fix Nginx (remove SSL references for now)
rm -f /etc/nginx/sites-enabled/leads.theinsurancedoctors.com
cat > /etc/nginx/sites-available/leads.theinsurancedoctors.com << 'EOF'
server {
    listen 80;
    server_name leads.theinsurancedoctors.com;

    location / {
        proxy_pass http://localhost:5001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    access_log /var/log/nginx/leadflow-access.log;
    error_log /var/log/nginx/leadflow-error.log;
}
EOF

ln -s /etc/nginx/sites-available/leads.theinsurancedoctors.com /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx

# Step 4: Get SSL certificate (certbot will auto-update nginx config)
echo "================================"cedoctors.com"
npm warn using --force Recommended protections disabled.

> rest-express@1.0.0 db:push
> drizzle-kit push

No config path provided, using default 'drizzle.config.ts'
Reading config file '/opt/LeadFlowTracker/drizzle.config.ts'
Using 'pg' driver for database querying
[⢿] Pulling schema from database...
Error: getaddrinfo ENOTFOUND db-memory-do-user-17481003-0.c.db.ondigitalocean.com
    at /opt/LeadFlowTracker/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async Object.query (/opt/LeadFlowTracker/node_modules/drizzle-kit/bin.cjs:80601:26)
    at async fromDatabase2 (/opt/LeadFlowTracker/node_modules/drizzle-kit/bin.cjs:19253:25) {
  errno: -3008,
  code: 'ENOTFOUND',
  syscall: 'getaddrinfo',
  hostname: 'db-memory-do-user-17481003-0.c.db.ondigitalocean.com'
}
nginx: [warn] conflicting server name "voice.theinsurancedoctors.com" on 0.0.0.0:80, ignored
nginx: [warn] conflicting server name "voice.theinsurancedoctors.com" on 0.0.0.0:443, ignored
nginx: [warn] conflicting server name "voice.theinsurancedoctors.com" on [::]:443, ignored
nginx: [warn] conflicting server name "voice.theinsurancedoctors.com" on [::]:80, ignored
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Requesting a certificate for leads.theinsurancedoctors.com

Certbot failed to authenticate some domains (authenticator: nginx). The Certificate Authority reported these problems:
  Domain: leads.theinsurancedoctors.com
  Type:   unauthorized
  Detail: 34.111.179.208: Invalid response from http://leads.theinsurancedoctors.com/.well-known/acme-challenge/iYCwetuNJjji91sAkVQHiEZeV-18iXQOsvwdBiyPwfA: 500

Hint: The Certificate Authority failed to verify the temporary nginx configuration changes made by Certbot. Ensure the listed domains point to this nginx server and that it is accessible from the internet.

Some challenges have failed.
Ask for help or search for solutions at https://community.letsencrypt.org. See the logfile /var/log/letsencrypt/letsencrypt.log or re-run Certbot with -v for more details.
[PM2][ERROR] File ecosystem.config.js malformated
Error [ERR_REQUIRE_ESM]: require() of ES Module /opt/LeadFlowTracker/ecosystem.config.js from /usr/lib/node_modules/pm2/lib/Common.js not supported.
ecosystem.config.js is treated as an ES module file as it is a .js file whose nearest parent package.json contains "type": "module" which declares all .js files in that package scope as ES modules.
Instead either rename ecosystem.config.js to end in .cjs, change the requiring code to use dynamic import() which is available in all CommonJS modules, or change "type": "module" to "type": "commonjs" in /opt/LeadFlowTracker/package.json to treat all .js files as CommonJS (using .mjs for all ES modules instead).

    at Common.parseConfig (/usr/lib/node_modules/pm2/lib/Common.js:331:12)
    at API._startJson (/usr/lib/node_modules/pm2/lib/API.js:934:25)
    at API.start (/usr/lib/node_modules/pm2/lib/API.js:329:12)
    at /usr/lib/node_modules/pm2/lib/binaries/CLI.js:297:13
    at /usr/lib/node_modules/pm2/node_modules/async/internal/withoutIndex.js:8:40
    at replenish (/usr/lib/node_modules/pm2/node_modules/async/internal/eachOfLimit.js:81:17)
    at /usr/lib/node_modules/pm2/node_modules/async/internal/eachOfLimit.js:86:9
    at eachLimit (/usr/lib/node_modules/pm2/node_modules/async/forEachLimit.js:47:45)
    at awaitable (/usr/lib/node_modules/pm2/node_modules/async/internal/awaitify.js:14:28)
    at Command.<anonymous> (/usr/lib/node_modules/pm2/lib/binaries/CLI.js:296:7)
    at Command.listener (/usr/lib/node_modules/pm2/node_modules/commander/index.js:315:8)
    at Command.emit (node:events:517:28)
    at Command.parseArgs (/usr/lib/node_modules/pm2/node_modules/commander/index.js:651:12)
    at Command.parse (/usr/lib/node_modules/pm2/node_modules/commander/index.js:474:21)
    at beginCommandProcessing (/usr/lib/node_modules/pm2/lib/binaries/CLI.js:154:13)
    at /usr/lib/node_modules/pm2/lib/binaries/CLI.js:228:7
    at /usr/lib/node_modules/pm2/lib/API.js:181:16
    at /usr/lib/node_modules/pm2/lib/Client.js:54:16
    at Timeout._onTimeout (/usr/lib/node_modules/pm2/lib/Client.js:369:9) {
  code: 'ERR_REQUIRE_ESM'
}
[PM2] Saving current process list...

>>>> In-memory PM2 is out-of-date, do:
>>>> $ pm2 update
In memory PM2 version: 6.0.8
Local PM2 version: 6.0.13

[PM2] Successfully saved in /root/.pm2/dump.pm2
================================
✅ Deployment Status:
================================

>>>> In-memory PM2 is out-of-date, do:
>>>> $ pm2 update
In memory PM2 version: 6.0.8
Local PM2 version: 6.0.13

┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ elevenlabs-bot     │ fork     │ 37   │ stopped   │ 0%       │ 0b       │
│ 1  │ notion-api-server  │ fork     │ 0    │ online    │ 0%       │ 57.1mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘

Testing local connection...

================================
🎉 Visit: https://leads.theinsurancedoctors.com
================================
root@chatbot-server:/opt/LeadFlowTracker# 